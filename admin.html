<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thomas Bresciani</title>
    <link rel="icon" type="image/jpeg" href="images/logo-tb---nero.jpg">
    <link rel="stylesheet" href="css/style.css?v=5">
    <link rel="stylesheet" href="css/login.css?v=5">
    <link rel="stylesheet" href="css/admin.css?v=5">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand" style="display:flex; align-items:center; gap:0.75rem;">
                <a href="index.html"><img src="images/logo-tb---nero.jpg" alt="Thomas Bresciani Personal Trainer" class="nav-logo"></a>
                <span style="color:#00AEEF; font-size:0.85rem; font-weight:700; letter-spacing:2px; text-transform:uppercase;">Admin</span>
            </div>
            <div class="nav-right">
                <ul class="nav-desktop-links">
                    <li><a href="index.html">Calendario</a></li>
                    <li><a href="chi-sono.html">Chi sono</a></li>
                    <li><a href="dove-sono.html">Dove sono</a></li>
                    <li><a href="admin.html">Amministrazione</a></li>
                </ul>
                <div id="navLoginLink" style="display:flex; align-items:center;">
                    <a href="login.html" class="nav-login-btn">Accedi</a>
                </div>
                <div id="navUserMenu" style="display:none; align-items:center; gap:0.4rem;">
                    <span id="navUserName" class="nav-user-name"></span>
                    <button id="navLogoutBtn" class="nav-logout-btn">Esci</button>
                </div>
                <button class="nav-hamburger" id="navHamburger" aria-label="Menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <div id="dashboardSection" class="dashboard-section">
        <div class="container">
            <!-- Tab Navigation -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="bookings">üìÖ Prenotazioni</button>
                <button class="admin-tab" data-tab="payments">üí≥ Pagamenti</button>
                <button class="admin-tab" data-tab="clients">üë§ Clienti</button>
                <button class="admin-tab" data-tab="schedule">‚öôÔ∏è Gestione Orari</button>
                <button class="admin-tab" data-tab="analytics">üìä Statistiche & Fatturato</button>
            </div>

            <!-- Tab: Bookings -->
            <div id="tab-bookings" class="tab-content active">
                <!-- Admin Calendar with Enrolled Users -->
                <div class="dashboard-card admin-calendar-card">
                    <div class="admin-calendar-controls">
                        <button id="adminPrevWeek" class="btn-control">&larr; Settimana Precedente</button>
                        <h4 id="adminCurrentWeek">Settimana Corrente</h4>
                        <button id="adminNextWeek" class="btn-control">Settimana Successiva &rarr;</button>
                    </div>

                    <div class="admin-day-selector" id="adminDaySelector">
                        <!-- Days will be generated by JavaScript -->
                    </div>

                    <div id="adminDayView" class="admin-day-view">
                        <!-- Selected day schedule will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Payments -->
            <div id="tab-payments" class="tab-content">
                <div class="dashboard-card">

                    <!-- Search Bar -->
                    <div class="payment-search">
                        <div class="search-input-group">
                            <input type="text" id="debtorSearchInput" placeholder="Cerca cliente per nome, telefono o email..."
                                   oninput="liveSearchDebtor()"
                                   onkeydown="if(event.key==='Escape') closeSearchDropdown()" />
                        </div>
                        <div id="debtorSearchDropdown" class="debtor-search-dropdown" style="display:none;"></div>
                    </div>

                    <div class="payments-stats">
                        <div class="payment-stat-card payment-stat-card--incasso">
                            <div class="payment-stat-icon">üí∞</div>
                            <h4>Totale da Incassare</h4>
                            <p class="payment-total" id="totalUnpaid">‚Ç¨0</p>
                        </div>
                        <div class="payment-stat-card payment-stat-card--clickable payment-stat-card--debitori" onclick="toggleDebtorsList()" title="Clicca per vedere la lista">
                            <div class="payment-stat-icon">üë§</div>
                            <h4>Clienti Debitori</h4>
                            <p class="payment-total" id="totalDebtors">0</p>
                            <span class="debtors-toggle-hint" id="debtorsToggleHint">‚ñº Mostra lista</span>
                        </div>
                        <div class="payment-stat-card payment-stat-card--clickable payment-stat-card--creditori" onclick="toggleCreditsList()" title="Clicca per vedere la lista">
                            <div class="payment-stat-icon">‚≠ê</div>
                            <h4>Clienti Creditori</h4>
                            <p class="payment-total" id="totalCreditors">0</p>
                            <span class="debtors-toggle-hint" id="creditorsToggleHint">‚ñº Mostra lista</span>
                        </div>
                        <div class="payment-stat-card payment-stat-card--credit">
                            <div class="payment-stat-icon">üí≥</div>
                            <h4>Totale Crediti</h4>
                            <p class="payment-total credit-total" id="totalCreditAmount">‚Ç¨0</p>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="debtorSearchResults" class="debtor-search-results" style="display: none;">
                        <div class="search-results-header">
                            <h4>Risultati ricerca</h4>
                            <button class="btn-clear-search" onclick="clearSearch()">‚úï Chiudi</button>
                        </div>
                        <div id="searchResultsList"></div>
                    </div>

                    <!-- All Debtors Collapsible List -->
                    <div id="debtorsList" class="debtors-list">
                        <!-- Debtors will be generated by JavaScript -->
                    </div>

                    <!-- Credits Collapsible List -->
                    <div id="creditsList" class="debtors-list credits-list" style="display:none;">
                        <!-- Credits will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Tab: Clients -->
            <div id="tab-clients" class="tab-content">
                <div class="dashboard-card">
                    <div class="clients-search-bar">
                        <input type="text" id="clientSearchInput"
                               placeholder="Cerca per nome, telefono o email..."
                               oninput="liveSearchClients()">
                    </div>
                    <div class="clients-list" id="clientsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Tab: Schedule Management -->
            <div id="tab-schedule" class="tab-content">
                <div class="dashboard-card">

                    <div id="scheduleManager">
                        <!-- Schedule management will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Tab: Analytics -->
            <div id="tab-analytics" class="tab-content">

                <!-- Filter Bar -->
                <div class="analytics-filter-bar">
                    <button class="filter-btn active" onclick="setAnalyticsFilter('this-month', this)">Questo mese</button>
                    <button class="filter-btn" onclick="setAnalyticsFilter('last-month', this)">Mese scorso</button>
                    <button class="filter-btn" onclick="setAnalyticsFilter('this-year', this)">Quest'anno</button>
                    <button class="filter-btn" onclick="setAnalyticsFilter('last-year', this)">Anno scorso</button>
                    <button class="filter-btn" onclick="setAnalyticsFilter('custom', this)">üìÖ Personalizzato</button>
                    <div class="filter-custom-dates" id="filterCustomDates" style="display:none;">
                        <input type="date" id="filterDateFrom">
                        <span style="color:#666;">‚Üí</span>
                        <input type="date" id="filterDateTo">
                        <button class="btn-apply-filter" onclick="applyCustomFilter()">Applica</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <h3>Fatturato</h3>
                        <p class="stat-value" id="monthlyRevenue">‚Ç¨0</p>
                        <span class="stat-change positive" id="revenueChange">+0%</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <h3>Prenotazioni Totali</h3>
                        <p class="stat-value" id="totalBookings">0</p>
                        <span class="stat-change" id="bookingsChange">+0%</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <h3>Clienti Attivi</h3>
                        <p class="stat-value" id="activeClients">0</p>
                        <span class="stat-change" id="clientsChange">+0%</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <h3>Tasso Occupazione</h3>
                        <p class="stat-value" id="occupancyRate">0%</p>
                        <span class="stat-change" id="occupancyChange">+0%</span>
                    </div>
                </div>

                <!-- Grafici (aperto di default) -->
                <div class="m-section open">
                    <div class="m-section-hd" onclick="this.closest('.m-section').classList.toggle('open')">
                        üìä Grafici <span class="m-sect-icon">‚ñº</span>
                    </div>
                    <div class="m-section-bd">
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h3>Prenotazioni nel tempo</h3>
                                <canvas id="bookingsChart"></canvas>
                            </div>
                            <div class="dashboard-card">
                                <h3>Distribuzione per tipo</h3>
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orari Popolari (chiuso di default su mobile) -->
                <div class="m-section">
                    <div class="m-section-hd" onclick="this.closest('.m-section').classList.toggle('open')">
                        ‚è∞ Orari Popolari <span class="m-sect-icon">‚ñº</span>
                    </div>
                    <div class="m-section-bd">
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h3>Fasce Orarie Popolari</h3>
                                <div id="popularTimes"><!-- Populated by JavaScript --></div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Fasce Orarie Non Popolari</h3>
                                <div id="unpopularTimes"><!-- Populated by JavaScript --></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ultime Prenotazioni (chiuso di default su mobile) -->
                <div class="m-section">
                    <div class="m-section-hd" onclick="this.closest('.m-section').classList.toggle('open')">
                        üìã Ultime Prenotazioni <span class="m-sect-icon">‚ñº</span>
                    </div>
                    <div class="m-section-bd">
                        <div class="dashboard-card">
                            <div class="table-responsive">
                                <table class="bookings-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Ora</th>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>WhatsApp</th>
                                            <th>Stato</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Azioni Rapide (chiuso di default su mobile) -->
                <div class="m-section">
                    <div class="m-section-hd" onclick="this.closest('.m-section').classList.toggle('open')">
                        ‚ö° Azioni Rapide <span class="m-sect-icon">‚ñº</span>
                    </div>
                    <div class="m-section-bd">
                        <div class="dashboard-card actions-card">
                            <h3>Azioni Rapide</h3>
                            <button class="btn-action" onclick="exportData()">üì• Esporta Dati</button>
                            <button class="btn-action" onclick="sendReminders()">üì± Invia Promemoria</button>
                            <button class="btn-action" onclick="viewRevenue()">üí≥ Dettaglio Fatturato</button>
                            <button class="btn-action" onclick="resetDemoData()" style="background-color: #dc3545;">üîÑ Reset Dati Demo</button>
                            <button class="btn-action" onclick="clearAllData()" style="background-color: #6c0000;">üóëÔ∏è Elimina Tutti i Dati</button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Tab: Analytics -->

        </div>
    </div>

    <!-- Debt Payment Popup -->
    <div id="debtPopupOverlay" class="debt-popup-overlay" onclick="closeDebtPopup()"></div>
    <div id="debtPopupModal" class="debt-popup-modal">
        <div class="debt-popup-header">
            <div>
                <h3 id="debtPopupName"></h3>
                <p id="debtPopupSubtitle"></p>
            </div>
            <button class="debt-popup-close" onclick="closeDebtPopup()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div id="debtPopupList" class="debt-popup-list"></div>
        <div class="debt-popup-payment">
            <div class="debt-payment-method-row">
                <span class="debt-field-label">Metodo di pagamento</span>
                <div class="debt-method-btns">
                    <button class="debt-method-btn active" data-method="contanti" onclick="selectPaymentMethod(this)">üíµ Contanti</button>
                    <button class="debt-method-btn" data-method="carta" onclick="selectPaymentMethod(this)">üí≥ Carta</button>
                    <button class="debt-method-btn" data-method="iban" onclick="selectPaymentMethod(this)">üè¶ IBAN</button>
                </div>
            </div>
            <div class="debt-payment-amount-row">
                <span class="debt-field-label">Importo incassato</span>
                <div class="debt-amount-wrapper">
                    <span class="debt-euro-sign">‚Ç¨</span>
                    <input type="number" id="debtAmountInput" min="0" step="1" value="0" oninput="updateCreditPreview()">
                </div>
            </div>
            <div id="debtExistingCreditRow" class="debt-existing-credit-row" style="display:none;">
                <span>üí≥ Credito disponibile: <strong id="debtExistingCreditAmt"></strong></span>
            </div>
            <div id="debtCreditRow" class="debt-credit-row" style="display:none;">
                <span id="debtCreditMsg"></span>
            </div>
        </div>
        <div class="debt-popup-footer">
            <label class="debt-select-all">
                <input type="checkbox" id="debtSelectAll" onchange="toggleAllDebts(this.checked)">
                Seleziona tutto
            </label>
            <div class="debt-popup-total">Dovuto: <strong id="debtSelectedTotal">‚Ç¨0</strong></div>
            <button class="debt-popup-pay-btn" id="debtPayBtn" onclick="paySelectedDebts()" disabled>‚úì Conferma</button>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="nav-sidebar-overlay" id="navSidebarOverlay" onclick="toggleNavMenu()"></div>
    <nav class="nav-sidebar" id="navSidebar">
        <div class="nav-sidebar-header">
            <img src="images/logo-tb---nero.jpg" alt="Thomas Bresciani" class="nav-sidebar-logo">
            <button class="nav-sidebar-close" onclick="toggleNavMenu()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <ul class="nav-sidebar-links">
            <li><a href="index.html">Calendario</a></li>
            <li><a href="chi-sono.html">Chi sono</a></li>
            <li><a href="dove-sono.html">Dove sono</a></li>
            <li><a href="admin.html">Amministrazione</a></li>
        </ul>
    </nav>

    <script>
        // Prevent iOS Safari auto-zoom on input focus.
        (function () {
            var vp = document.querySelector('meta[name="viewport"]');
            if (!vp) return;
            document.addEventListener('touchstart', function (e) {
                var tag = e.target.tagName;
                if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') {
                    vp.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1');
                }
            }, { passive: true });
            document.addEventListener('focusout', function (e) {
                var tag = e.target.tagName;
                if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') {
                    setTimeout(function () {
                        vp.setAttribute('content', 'width=device-width, initial-scale=1');
                    }, 300);
                }
            });
        }());
    </script>
    <script src="js/data.js?v=5"></script>
    <script src="js/auth.js?v=5"></script>
    <script src="js/chart-mini.js?v=5"></script>
    <script src="js/admin.js?v=5"></script>
</body>
</html>
