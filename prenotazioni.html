<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json?v=2">
    <meta name="theme-color" content="#00AEEF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TB Training">
    <title>Le mie prenotazioni â€“ Thomas Bresciani</title>
    <link rel="icon" type="image/jpeg" href="images/logo-tb---nero.jpg">
    <link rel="stylesheet" href="css/style.css?v=4">
    <link rel="stylesheet" href="css/login.css?v=4">
    <link rel="stylesheet" href="css/prenotazioni.css?v=4">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html"><img src="images/logo-tb---nero.jpg" alt="Thomas Bresciani Personal Trainer" class="nav-logo"></a>
            </div>
            <div class="nav-right">
                <ul class="nav-desktop-links">
                    <li><a href="index.html">Calendario</a></li>
                    <li><a href="chi-sono.html">Chi sono</a></li>
                    <li><a href="dove-sono.html">Dove sono</a></li>
                    <li><a href="admin.html">Amministrazione</a></li>
                </ul>
                <div id="navLoginLink" style="display:flex; align-items:center;">
                    <a href="login.html" class="nav-login-btn">Accedi</a>
                </div>
                <div id="navUserMenu" style="display:none; align-items:center; gap:0.4rem;">
                    <span id="navUserName" class="nav-user-name"></span>
                    <button id="navLogoutBtn" class="nav-logout-btn">Esci</button>
                </div>
                <button class="nav-hamburger" id="navHamburger" aria-label="Menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="preno-page">
        <div class="container">

            <!-- Header utente -->
            <div class="preno-header">
                <div class="preno-avatar" id="prenoAvatar"></div>
                <div class="preno-header-info">
                    <div class="preno-header-top">
                        <h1 class="preno-title" id="prenoUserName">Le mie prenotazioni</h1>
                        <button class="preno-edit-btn" onclick="openEditProfileModal()">âœï¸<span class="preno-edit-label"> Modifica profilo</span></button>
                    </div>
                    <p class="preno-subtitle" id="prenoUserEmail"></p>
                </div>
            </div>

            <!-- Saldo -->
            <div class="preno-saldo-card">
                <div class="preno-saldo-row">
                    <span class="preno-saldo-label">ğŸ’³ Credito disponibile</span>
                    <span class="preno-saldo-value preno-saldo-credit" id="prenoCreditAmount">â‚¬0,00</span>
                </div>
                <div class="preno-saldo-divider"></div>
                <div class="preno-saldo-row">
                    <span class="preno-saldo-label">âš ï¸ Da pagare</span>
                    <span class="preno-saldo-value preno-saldo-debit" id="prenoDebitAmount">â‚¬0,00</span>
                </div>
            </div>

            <!-- Warning certificato medico -->
            <div id="prenoCertWarning"></div>

            <!-- Tabs -->
            <div class="preno-tabs">
                <button class="preno-tab active" id="tabProssime"    onclick="switchPrenoTab('upcoming')">Prossime</button>
                <button class="preno-tab"         id="tabPassate"     onclick="switchPrenoTab('past')">Passate</button>
                <button class="preno-tab"         id="tabTransazioni" onclick="switchPrenoTab('transactions')">Transazioni</button>
            </div>

            <!-- Lista prenotazioni -->
            <div id="prenoList" class="preno-list"></div>

            <!-- CTA -->
            <div class="preno-cta">
                <a href="index.html" class="preno-cta-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Prenota una lezione
                </a>
            </div>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Thomas Bresciani Personal Trainer â€” Via S. Rocco, 1, Sabbio Chiese (BS)</p>
        </div>
    </footer>

    <!-- WhatsApp floating button -->
    <a href="https://wa.me/393347251783" class="whatsapp-fab" target="_blank" rel="noopener" aria-label="Contattami su WhatsApp">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    </a>

    <!-- Sidebar -->
    <div class="nav-sidebar-overlay" id="navSidebarOverlay" onclick="toggleNavMenu()"></div>
    <nav class="nav-sidebar" id="navSidebar">
        <div class="nav-sidebar-header">
            <img src="images/logo-tb---nero.jpg" alt="Thomas Bresciani" class="nav-sidebar-logo">
            <button class="nav-sidebar-close" onclick="toggleNavMenu()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <ul class="nav-sidebar-links">
            <li><a href="index.html">Calendario</a></li>
            <li><a href="chi-sono.html">Chi sono</a></li>
            <li><a href="dove-sono.html">Dove sono</a></li>
            <li><a href="admin.html">Amministrazione</a></li>
        </ul>
    </nav>

    <!-- Edit profile modal -->
    <div id="editProfileModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeEditProfileModal()">
        <div class="modal-box">
            <button class="modal-close" onclick="closeEditProfileModal()">âœ•</button>
            <h3 class="edit-profile-title">Modifica profilo</h3>
            <form id="editProfileForm" class="booking-form">
                <div class="form-group">
                    <label for="editName">Nome completo</label>
                    <input type="text" id="editName" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="editWhatsapp">Numero WhatsApp</label>
                    <input type="tel" id="editWhatsapp" placeholder="+39 348 1234567" autocomplete="tel">
                </div>
                <div class="form-group">
                    <label for="editCertScadenza">Scadenza certificato medico</label>
                    <input type="date" id="editCertScadenza">
                </div>
                <div id="editPasswordSection">
                    <div class="form-group">
                        <label for="editPassword">Nuova password <span class="edit-profile-label-note">(lascia vuoto per non cambiare)</span></label>
                        <input type="password" id="editPassword" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="editPasswordConfirm">Conferma nuova password</label>
                        <input type="password" id="editPasswordConfirm" autocomplete="new-password">
                    </div>
                </div>
                <div id="editProfileError" class="edit-profile-error" style="display:none;"></div>
                <button type="submit" class="btn-primary" style="width:100%;margin-top:0.5rem">Salva modifiche</button>
            </form>
        </div>
    </div>

    <script src="js/ui.js?v=1"></script>
    <script src="js/data.js?v=5"></script>
    <script src="js/auth.js?v=6"></script>
    <script>
        // â”€â”€ Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const _user = getCurrentUser();
        if (!_user) window.location.href = 'login.html';

        // â”€â”€ Date formatter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function formatBookingDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            const days   = ['Domenica','LunedÃ¬','MartedÃ¬','MercoledÃ¬','GiovedÃ¬','VenerdÃ¬','Sabato'];
            const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
                            'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
            return `${days[d.getDay()]} ${day} ${months[month - 1]} ${year}`;
        }

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _currentTab = 'upcoming';

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            const user = getCurrentUser();
            if (!user) return;

            // Fill header
            document.getElementById('prenoUserName').textContent = user.name;
            document.getElementById('prenoUserEmail').textContent = user.email;
            document.getElementById('prenoAvatar').textContent = user.name.charAt(0).toUpperCase();

            // Verifica le richieste pendenti: se la lezione Ã¨ entro 2h, nega l'annullamento
            BookingStorage.processPendingCancellations();

            renderPrenoList();
            renderCreditBalance();
            renderCertWarning();

            // Polling: aggiorna la lista ogni 3s finchÃ© ci sono annullamenti in attesa
            // (necessario perchÃ© un altro utente potrebbe prenotare lo slot da un altro tab)
            let _pollInterval = null;
            function _startPolling() {
                if (_pollInterval) return;
                _pollInterval = setInterval(() => {
                    const user = getCurrentUser();
                    if (!user) { clearInterval(_pollInterval); return; }
                    const _myPhone = user.whatsapp ? normalizePhone(user.whatsapp) : '';
                    const hasPending = BookingStorage.getAllBookings().some(b => {
                        const emailMatch = user.email && b.email && b.email.toLowerCase() === user.email.toLowerCase();
                        const phoneMatch = _myPhone && b.whatsapp && normalizePhone(b.whatsapp) === _myPhone;
                        return (emailMatch || phoneMatch) && b.status === 'cancellation_requested';
                    });
                    if (!hasPending) {
                        clearInterval(_pollInterval);
                        _pollInterval = null;
                    }
                    BookingStorage.processPendingCancellations();
                    renderPrenoList();
                    renderCreditBalance();
                }, 3000);
            }
            function _stopPolling() { if (_pollInterval) { clearInterval(_pollInterval); _pollInterval = null; } }
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) _stopPolling(); else _startPolling();
            });
            _startPolling();
        });

        // â”€â”€ Credit / debit balance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderCreditBalance() {
            const user = getCurrentUser();
            if (!user) return;

            const balance = CreditStorage.getBalance(user.whatsapp, user.email);
            const { upcoming, past } = getUserBookings();
            const bookingDebt = [...upcoming, ...past]
                .filter(b => !b.paid && b.status !== 'cancelled' && b.status !== 'cancellation_requested')
                .reduce((sum, b) => sum + (SLOT_PRICES[b.slotType] || 0) - (b.creditApplied || 0), 0);
            const manualDebt = ManualDebtStorage.getBalance(user.whatsapp, user.email);
            const totalDebt = bookingDebt + manualDebt;

            // Compensazione: credito e debito si azzerano a vicenda
            const displayCredit = Math.max(0, balance - totalDebt);
            const displayDebit  = Math.max(0, totalDebt - balance);

            document.getElementById('prenoCreditAmount').textContent = `â‚¬${displayCredit.toFixed(2)}`;
            document.getElementById('prenoDebitAmount').textContent  = `â‚¬${displayDebit.toFixed(2)}`;
        }

        // â”€â”€ Tab switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchPrenoTab(tab) {
            _currentTab = tab;
            document.getElementById('tabProssime').classList.toggle('active',    tab === 'upcoming');
            document.getElementById('tabPassate').classList.toggle('active',     tab === 'past');
            document.getElementById('tabTransazioni').classList.toggle('active', tab === 'transactions');
            renderPrenoList();
        }

        // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPrenoList() {
            if (_currentTab === 'transactions') { renderTransazioni(); return; }
            const { upcoming, past } = getUserBookings();
            const list = _currentTab === 'upcoming' ? upcoming : past;
            const container = document.getElementById('prenoList');

            if (!list.length) {
                const msg = _currentTab === 'upcoming'
                    ? 'Nessuna prenotazione futura.<br><a href="index.html" class="preno-empty-link">Prenota la tua prima lezione â†’</a>'
                    : 'Nessuna prenotazione passata.';
                container.innerHTML = `<div class="preno-empty">${msg}</div>`;
                return;
            }

            container.innerHTML = list.map(b => buildCard(b, _currentTab === 'upcoming')).join('');
        }

        function buildCard(b, showCancel) {
            const slotName = (SLOT_NAMES && SLOT_NAMES[b.slotType]) || b.slotType || 'â€”';
            const displayDate = formatBookingDate(b.date);

            let payBadge = '';
            if (b.status === 'cancelled') {
                payBadge = `<span class="preno-badge preno-badge-cancelled">âœ• Annullata</span>`;
            } else if (b.paid) {
                const methodLabels = { credito: 'ğŸ’³ Pagata con Credito', contanti: 'ğŸ’µ Pagata con Contanti', carta: 'ğŸ’³ Pagata con Carta', iban: 'ğŸ¦ Pagata con IBAN' };
                const method = methodLabels[b.paymentMethod] || 'âœ“ Pagata';
                payBadge = `<span class="preno-badge preno-badge-paid">${method}</span>`;
            } else if ((b.creditApplied || 0) > 0) {
                const remaining = (SLOT_PRICES[b.slotType] || 0) - b.creditApplied;
                payBadge = `<span class="preno-badge preno-badge-partial">ğŸ’³ Credito parziale â€” â‚¬${remaining} da pagare</span>`;
            } else {
                payBadge = `<span class="preno-badge preno-badge-unpaid">Da pagare</span>`;
            }

            const _lessonStart = new Date(`${b.date}T${b.time.split(' - ')[0].trim()}:00`);
            const _lessonPast  = _lessonStart <= new Date();
            const _isGroupClass = b.slotType !== 'group-class'; // solo Slot prenotato (rosso) ha cutoff 3gg; Lezione di Gruppo e Autonomia â†’ 3h
            const THREE_DAYS_MS  = 3 * 24 * 60 * 60 * 1000;
            const THREE_HOURS_MS = 3 * 60 * 60 * 1000;
            const _msToLesson = _lessonStart - new Date();
            const _canCancelSlot       = !_isGroupClass && (_msToLesson >= THREE_DAYS_MS);
            const _canCancelGroupClass =  _isGroupClass && (_msToLesson >= THREE_HOURS_MS);

            let cancelBtn = '';
            if (showCancel && b.status !== 'cancelled' && !_lessonPast) {
                if (_isGroupClass) {
                    // Lezione di Gruppo / Autonomia: annullabile fino a 3 ore prima
                    if (b.status === 'cancellation_requested') {
                        cancelBtn = `<div class="preno-cancel-pending">â³ Annullamento in attesa</div>`;
                    } else if (_canCancelGroupClass) {
                        cancelBtn = `<button class="preno-cancel-btn" onclick="requestCancellation('${b.id}')">Richiedi annullamento</button>`;
                    } else {
                        cancelBtn = `<div class="preno-cancel-locked">ğŸ”’ Non annullabile (meno di 3 ore)</div>`;
                    }
                } else if (b.status === 'cancellation_requested') {
                    cancelBtn = `<div class="preno-cancel-pending">â³ Annullamento in attesa</div>`;
                } else if (_canCancelSlot) {
                    // Slot prenotato (rosso): annullabile solo con 3 giorni di anticipo
                    cancelBtn = `<button class="preno-cancel-btn" onclick="requestCancellation('${b.id}')">Annulla prenotazione</button>`;
                } else {
                    cancelBtn = `<div class="preno-cancel-locked">ğŸ”’ Non annullabile (meno di 3 giorni)</div>`;
                }
            }

            return `
                <div class="preno-card ${b.slotType}">
                    <div class="preno-card-left">
                        <div class="preno-card-date">ğŸ“… ${displayDate}</div>
                        <div class="preno-card-time">ğŸ• ${b.time}</div>
                        <div class="preno-card-type">${slotName}</div>
                    </div>
                    <div class="preno-card-right">
                        ${payBadge}
                        ${cancelBtn}
                    </div>
                </div>`;
        }

        // â”€â”€ Transazioni â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderTransazioni() {
            const user = getCurrentUser();
            if (!user) return;
            const container = document.getElementById('prenoList');
            const entries = [];

            function normPhone(p) {
                return (p || '').replace(/[\s\-().+]/g, '').replace(/^0039/, '').replace(/^39/, '');
            }
            const uPhone = normPhone(user.whatsapp);
            function matchUser(w, e) {
                return (uPhone && normPhone(w) === uPhone) ||
                       (user.email && e && e.toLowerCase() === user.email.toLowerCase());
            }

            const methodMap = { contanti: 'ğŸ’µ Contanti', carta: 'ğŸ’³ Carta', iban: 'ğŸ¦ IBAN', credito: 'ğŸ’³ Credito' };

            // 1. Tutte le prenotazioni pagate â€” prezzo pieno, singole
            BookingStorage.getAllBookings()
                .filter(b => !b.id?.startsWith('demo-') && matchUser(b.whatsapp, b.email) && b.paid)
                .forEach(b => {
                    const price = SLOT_PRICES[b.slotType] || 0;
                    if (price <= 0) return;
                    const slotName = (SLOT_NAMES && SLOT_NAMES[b.slotType]) || b.slotType || 'â€”';
                    const [by, bm, bd] = b.date.split('-');
                    entries.push({
                        date: new Date(b.paidAt || `${b.date}T12:00:00`),
                        icon: 'ğŸ‹ï¸', label: slotName,
                        sub: `${bd}/${bm}/${by} Â· ${methodMap[b.paymentMethod] || b.paymentMethod || ''}`,
                        amount: -price
                    });
                });

            // 2. Storico crediti â€” entrate positive + pagamenti informativi (amount=0, displayAmount>0)
            //    Le uscite (credito usato) sono giÃ  coperte dalle singole prenotazioni
            const creditRec = CreditStorage.getRecord(user.whatsapp, user.email);
            (creditRec?.history || []).filter(e => e.amount > 0 || (e.amount === 0 && (e.displayAmount || 0) > 0)).forEach(e => {
                entries.push({
                    date: new Date(e.date), icon: 'ğŸ’³',
                    label: e.note || 'Credito aggiunto',
                    sub: '', amount: e.displayAmount ?? e.amount
                });
            });

            // 3. Storico debiti manuali
            const debtRec = ManualDebtStorage.getRecord(user.whatsapp, user.email);
            (debtRec?.history || []).forEach(e => {
                const isPaid = e.amount < 0;
                entries.push({
                    date: new Date(e.date),
                    icon: isPaid ? 'âœ“' : 'âœï¸',
                    label: e.note || (isPaid ? 'Debito saldato' : 'Addebito'),
                    sub: '',
                    amount: -Math.abs(e.amount) // debito aggiunto e saldato: sempre uscita
                });
            });

            // 4. Prenotazioni annullate â€” voce "Annullata" con -â‚¬0
            BookingStorage.getAllBookings()
                .filter(b => !b.id?.startsWith('demo-') && matchUser(b.whatsapp, b.email) && b.status === 'cancelled')
                .forEach(b => {
                    const slotName = (SLOT_NAMES && SLOT_NAMES[b.slotType]) || b.slotType || 'â€”';
                    const [by, bm, bd] = b.date.split('-');
                    entries.push({
                        date: new Date(b.cancelledAt || `${b.date}T12:00:00`),
                        icon: 'âœ•', label: slotName,
                        sub: `${bd}/${bm}/${by} Â· âœ• Annullata`,
                        amount: -(SLOT_PRICES[b.slotType] || 0), cancelled: true
                    });
                });

            entries.sort((a, b) => b.date - a.date);

            if (!entries.length) {
                container.innerHTML = `<div class="preno-empty">Nessuna transazione trovata.</div>`;
                return;
            }

            const fmtD = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            container.innerHTML = entries.map(e => {
                const pos = e.amount > 0;
                const sign = (e.cancelled || e.amount < 0) ? '-' : '+';
                const cls  = pos ? 'tx-pos' : 'tx-neg';
                return `<div class="preno-tx-row">
                    <div class="preno-tx-icon">${e.icon}</div>
                    <div class="preno-tx-info">
                        <div class="preno-tx-label">${e.label}</div>
                        ${e.sub ? `<div class="preno-tx-sub">${e.sub}</div>` : ''}
                    </div>
                    <div class="preno-tx-right">
                        <div class="preno-tx-amount ${cls}">${sign}â‚¬${Math.abs(e.amount).toFixed(2)}</div>
                        <div class="preno-tx-date">${fmtD(e.date)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // â”€â”€ Cancellation request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function requestCancellation(id) {
            const booking = BookingStorage.getAllBookings().find(b => b.id === id);
            if (!booking) return;

            if (booking.slotType === 'group-class') {
                // Slot prenotato: annullamento immediato + conversione slot in Lezione di Gruppo
                const msg = 'Confermare l\'annullamento?\n\n' +
                    'La prenotazione sarÃ  annullata e lo slot diventerÃ  una Lezione di Gruppo aperta al pubblico.';
                if (!confirm(msg)) return;
                BookingStorage.cancelAndConvertSlot(id);
            } else {
                const msg = 'Richiedere l\'annullamento?\n\n' +
                    'â€¢ Se qualcuno prenota al tuo posto, la prenotazione sarÃ  annullata.\n' +
                    'â€¢ Se entro 2 ore dalla lezione nessuno ha preso il tuo posto, l\'annullamento viene negato e dovrai presentarti.';
                if (!confirm(msg)) return;
                BookingStorage.requestCancellation(id);
            }
            renderPrenoList();
        }

        // â”€â”€ Certificato medico warning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderCertWarning() {
            const user = getCurrentUser();
            const el   = document.getElementById('prenoCertWarning');
            if (!user || !el) return;

            const stored = getUserByEmail(user.email);
            const scad   = stored?.certificatoMedicoScadenza;
            if (!scad) { el.innerHTML = ''; return; }

            const today   = new Date(); today.setHours(0,0,0,0);
            const scadDt  = new Date(scad + 'T00:00:00');
            const diffMs  = scadDt - today;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            const [y, m, d] = scad.split('-');
            const dateLabel = `${d}/${m}/${y}`;

            if (diffDays <= 0) {
                el.innerHTML = `<div class="preno-cert-warning preno-cert-expired">ğŸ¥ Certificato medico scaduto il ${dateLabel} <span class="preno-cert-update" onclick="openEditProfileModal()">(aggiorna)</span></div>`;
            } else if (diffDays <= 15) {
                el.innerHTML = `<div class="preno-cert-warning preno-cert-expiring">â³ Mancano ${diffDays} giorn${diffDays === 1 ? 'o' : 'i'} alla scadenza del tuo certificato medico <span class="preno-cert-update" onclick="openEditProfileModal()">(aggiorna)</span></div>`;
            } else {
                el.innerHTML = '';
            }
        }

        // â”€â”€ Edit profile modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openEditProfileModal() {
            const user = getCurrentUser();
            if (!user) return;
            const stored = getUserByEmail(user.email);
            document.getElementById('editName').value            = user.name || '';
            document.getElementById('editEmail').value           = user.email || '';
            document.getElementById('editWhatsapp').value        = user.whatsapp || '';
            document.getElementById('editCertScadenza').value    = stored?.certificatoMedicoScadenza || '';
            document.getElementById('editPassword').value        = '';
            document.getElementById('editPasswordConfirm').value = '';
            document.getElementById('editPasswordSection').style.display =
                (user.provider === 'google') ? 'none' : 'block';
            document.getElementById('editProfileError').style.display = 'none';
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = getCurrentUser();
            if (!user) return;

            const name     = document.getElementById('editName').value.trim();
            const email    = document.getElementById('editEmail').value.trim();
            const whatsapp = document.getElementById('editWhatsapp').value.trim();
            const certSc   = document.getElementById('editCertScadenza').value;
            const pass     = document.getElementById('editPassword').value;
            const passConf = document.getElementById('editPasswordConfirm').value;

            const errEl = document.getElementById('editProfileError');
            const btn   = e.target.querySelector('button[type="submit"]');
            function showErr(msg) { errEl.textContent = msg; errEl.style.display = 'block'; }

            if (!name)  return showErr('Il nome Ã¨ obbligatorio.');
            if (!email) return showErr("L'email Ã¨ obbligatoria.");
            if (pass && pass.length < 6) return showErr('La password deve essere di almeno 6 caratteri.');
            if (pass && pass !== passConf) return showErr('Le password non coincidono.');

            setLoading(btn, true, 'Salvataggio...');
            const result = updateUserProfile(user.email, {
                name,
                email,
                whatsapp: whatsapp ? normalizePhone(whatsapp) : '',
                certificatoMedicoScadenza: certSc
            }, pass || null);

            if (!result.ok) {
                setLoading(btn, false);
                return showErr(result.error);
            }

            const updated = getCurrentUser();
            document.getElementById('prenoUserName').textContent = updated.name;
            document.getElementById('prenoUserEmail').textContent = updated.email;
            document.getElementById('prenoAvatar').textContent = updated.name.charAt(0).toUpperCase();
            updateNavAuth();
            renderCertWarning();
            setLoading(btn, false);
            closeEditProfileModal();
            showToast('Profilo aggiornato.', 'success');
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/Palestra/sw.js');
        }
    </script>
</body>
</html>
